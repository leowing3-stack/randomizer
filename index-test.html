<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<title>SocialBurst – Deal a Plan</title>
<link rel="preconnect" href="https://docs.google.com" crossorigin>
<link rel="preconnect" href="https://lh3.googleusercontent.com" crossorigin>

<style>
  @font-face { font-family: "BrotherBold"; src: url("./SocialBurstRandomizer/fonts/BROTHER-Bold.ttf") format("truetype"); }
  @font-face { font-family: "Lexend"; src: url("./SocialBurstRandomizer/fonts/Lexend-VariableFont_wght.ttf") format("truetype"); }
  @font-face { font-family: "MadeTommyBold"; src: url("./SocialBurstRandomizer/fonts/MADE TOMMY Bold_PERSONAL USE.otf") format("opentype"); }

  :root{
    --purple:#8338EC;
    --yellow:#FFEC1F;
    --white:#ffffff;
    --black:#000000;
    --safe-area-top: env(safe-area-inset-top, 18px);
    --safe-area-left: env(safe-area-inset-left, 18px);
    --safe-area-bottom: env(safe-area-inset-bottom, 22px);
  }

  body{
    margin:0;
    min-height:100dvh;
    background: var(--purple);
    color:var(--white);
    font-family: Lexend, sans-serif;
    overflow:hidden;
  }

  .brand-badge{
    position:fixed;
    top: var(--safe-area-top);
    left: var(--safe-area-left);
    z-index:30;
    display:flex; align-items:center; gap:12px;
  }
  .brand-badge img {
    width:216px;
    height:216px;
  }

  /* CHANGED: align text center with logo center, and set Social/Burst fonts */
  .brand-badge .brand-name{
    position:fixed;
    /* logo center (216/2=108) minus half text height (72/2=36) */
    top: calc(var(--safe-area-top) + 108px - 36px);
    left:50%;
    transform: translateX(-50%);
    z-index:31;
    font-size:72px; /* unchanged */
    line-height:1;
    opacity:1;
    transition: opacity .45s ease;
    white-space:nowrap;
  }
  .brand-badge .brand-name .social{ font-family: "MadeTommyBold", sans-serif; }
  .brand-badge .brand-name .burst { font-family: "BrotherBold",   sans-serif; }
  .brand-badge .brand-name .white{ color:var(--white); }
  .brand-badge .brand-name .yellow{ color:var(--yellow); }
  .is-open .brand-badge .brand-name{ opacity:0; }

  .stage{
    position:relative;
    height:100dvh;
    display:flex; align-items:center; justify-content:center;
    perspective: 1600px;
  }

  /* NEW: two-column layout while preserving your .stage styles */
  .stage.grid-2{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap: clamp(18px, 3vw, 28px);
    align-items:center;
    justify-items:center;
    height:100dvh;
  }

  .stack{ position:relative; width:min(88vw, 660px); aspect-ratio:2/1; display:grid; place-items:center; }
  .click-overlay{ position:absolute; inset:0; cursor:pointer; z-index:19; background:transparent; }

  .envelope{
    position:absolute; inset:0;
    display:grid; place-items:center;
    transform-style:preserve-3d;
    transition: transform 0.8s ease;
    z-index:10;
  }
  /* Scoped flip so each card opens independently */
  #cardEvents.is-back .envelope{ transform: rotateY(180deg); }
  #cardDeals.is-back  .envelope{ transform: rotateY(180deg); }

  .env-face{
    position:absolute; inset:0;
    border-radius:10px;
    background:var(--white);
    border:1px solid var(--black);
    display:grid; place-items:center;
    backface-visibility:hidden;
  }
  .env-front{ transform: rotateY(0deg); }
  .env-front .top-secret{
    color:var(--purple); font-weight:800;
    font-size: clamp(24px, 5vw, 44px);
  }

  /* ===== BACK with true triangular flap (SVG) ===== */
  .env-back{
    transform: rotateY(180deg);
    transform-style: preserve-3d;
    overflow:hidden;
  }
  .env-back .back-body{
    position:absolute; inset:0;
    background: var(--white);
    border-radius:10px;
    box-shadow: inset 0 0 0 1px var(--black);
    z-index:1;
  }
  .flap3d{
    position:absolute; left:0; right:0; top:0;
    height:50%;
    transform-origin: top center;
    transform: rotateX(0deg);
    transition: transform 0.9s ease 0.15s;
    will-change: transform;
    z-index:15;
    transform-style: preserve-3d;
    backface-visibility: visible;
    pointer-events:none;
  }
  .flap-svg{ position:absolute; inset:0; width:100%; height:100%; display:block; }
  .flap-tri{
    fill: var(--white);
    stroke: var(--black);
    stroke-width: 2.5;
    stroke-linejoin: round;
    vector-effect: non-scaling-stroke;
  }
  .back-top-guide{
    position:absolute; left:2%; right:2%; top:1%;
    height:0; border-top:2px solid rgba(0,0,0,0.18);
    z-index:2; pointer-events:none;
  }
  /* Scoped open so each card animates independently */
  #cardEvents.is-open .flap3d{ transform: rotateX(-175deg); }
  #cardDeals.is-open  .flap3d{ transform: rotateX(-175deg); }

  .letter-wrap{
    position:absolute; inset:0;
    display:flex; align-items:center; justify-content:center;
    z-index:20; pointer-events:none;
  }
  .letter{
    width:min(68vw, 520px); max-height:72vh;
    aspect-ratio:4/5;
    background:var(--white);
    border:1px solid var(--black);
    border-radius:8px;
    box-shadow:0 12px 30px rgba(0,0,0,0.25);
    transform-origin: bottom center;
    transform: translateY(25%) scaleY(0.5);
    opacity:0;
    transition: transform 0.8s ease, opacity 0.6s ease;
    display:flex; flex-direction:column; justify-content:center;
    padding: clamp(18px, 3.5vw, 28px);
    gap: clamp(12px, 2vw, 20px);
    text-align:center;
  }
  /* Scoped letter open */
  #cardEvents.is-open .letter,
  #cardDeals.is-open  .letter{
    transform: translateY(calc(-1 * var(--safe-area-top) / 2)) scaleY(1);
    opacity:1;
    pointer-events:auto;
  }

  .letter h5{ margin:0; color:var(--purple); font-weight:800; font-size:clamp(16px,3.2vw,20px); }
  .letter .title{ margin:0; color:var(--purple); font-weight:800; font-size:clamp(22px,5.2vw,34px); }
  .letter .venue{ margin:0; color:var(--purple); font-weight:800; font-size:clamp(16px,3.8vw,20px); opacity:0.95; }
  .letter .more{ margin-top:10px; }
  .letter .more a{ color:var(--yellow); text-decoration:underline; font-weight:800; }

  .reset-wrap{
    position:fixed; left:0; right:0; bottom: var(--safe-area-bottom);
    display:flex; justify-content:center; z-index:25;
    opacity:0; transform:translateY(10px);
    transition: opacity 0.25s ease, transform 0.25s ease;
    pointer-events:none;
  }
  .show-reset .reset-wrap{ opacity:1; transform:translateY(0); pointer-events:auto; }
  .reset-btn{ 
    width:64px; height:64px; background:var(--yellow);
    border-radius:999px; border:none; cursor:pointer;
    box-shadow:0 8px 22px rgba(0,0,0,0.25);
    font-size:28px; font-weight:bold; color:var(--black);
    line-height:1; display:flex; align-items:center; justify-content:center;
  }

  /* Center the opened card (spans both columns) without changing your visuals */
  .stage.grid-2 .stack{
    transition: transform .45s ease, grid-column .45s ease, z-index .2s ease;
  }
  .stage.grid-2 .stack.is-open-centered{
    grid-column: 1 / -1;
    z-index: 22;
  }

  /* --- Mobile layout: logo centered at top, text below --- */
  @media (max-width: 860px) {
    .stage.grid-2{
      grid-template-columns: 1fr;
      height:auto;
      min-height:100dvh;
      padding-block: clamp(16px, 5vw, 28px);
    }
    .stage.grid-2 .stack.is-open-centered{
      grid-column: 1;
    }
  }

  @media (max-width: 600px) {
    .brand-badge {
      position: absolute;
      top: var(--safe-area-top);
      left: 50%;
      transform: translateX(-50%);
      flex-direction: column;
      align-items: center;
      gap: 8px;
    }

    .brand-badge img {
      width: 180px;
      height: 180px;
      margin: 0 auto;
    }

    .brand-badge .brand-name {
      position: static;
      transform: none;
      font-size: clamp(28px, 9vw, 48px);
      line-height: 1.1;
      text-align: center;
      white-space: nowrap;
    }
  }
</style>
</head>
<body>

<div class="brand-badge">
  <img src="./SocialBurstRandomizer/img/logo-nobg.png?v=2" alt="logo"/>
  <div class="brand-name">
    <span class="social white">Social</span> <span class="burst yellow">Burst</span>
  </div>
</div>

<main class="stage grid-2">
  <!-- LEFT: EVENTS (community / live_music / pub_quiz) -->
  <section id="cardEvents" class="stack">
    <div id="clickOverlay" class="click-overlay" aria-label="Open events"></div>

    <div class="envelope">
      <div class="env-face env-front">
        <div style="display:flex; flex-direction:column; align-items:center; justify-content:center; gap:2px;">
          <div class="top-secret" style="margin:0;">TOP SECRET</div>
          <div class="subtitle" style="color:#8338EC; font-weight:700; font-size:clamp(18px,4vw,26px); margin:0;">Events Happening Today</div>
        </div>
      </div>

      <div class="env-face env-back">
        <div class="back-body"></div>
        <div class="back-top-guide"></div>
        <div class="flap3d" aria-hidden="true">
          <svg class="flap-svg" viewBox="0 0 100 100" preserveAspectRatio="none" aria-hidden="true">
            <polygon class="flap-tri" points="0,0 100,0 50,100"></polygon>
          </svg>
        </div>
      </div>
    </div>

    <div class="letter-wrap">
      <article id="letter" class="letter">
        <h5>You Are Invited To….</h5>
        <div id="evTitle" class="title">Loading…</div>
        <div id="evVenue" class="venue"></div>
        <div class="more"><a id="evLink" href="#" target="_blank" rel="noopener noreferrer">Open details</a></div>
      </article>
    </div>
  </section>

  <!-- RIGHT: DEALS (category contains 'deal') -->
  <section id="cardDeals" class="stack">
    <div id="clickOverlayDeals" class="click-overlay" aria-label="Open deals"></div>

    <div class="envelope">
      <div class="env-face env-front">
        <div style="display:flex; flex-direction:column; align-items:center; justify-content:center; gap:2px;">
          <div class="top-secret" style="margin:0;">TOP SECRET</div>
          <div class="subtitle" style="color:#8338EC; font-weight:700; font-size:clamp(18px,4vw,26px); margin:0;">Discounts Today</div>
        </div>
      </div>

      <div class="env-face env-back">
        <div class="back-body"></div>
        <div class="back-top-guide"></div>
        <div class="flap3d" aria-hidden="true">
          <svg class="flap-svg" viewBox="0 0 100 100" preserveAspectRatio="none" aria-hidden="true">
            <polygon class="flap-tri" points="0,0 100,0 50,100"></polygon>
          </svg>
        </div>
      </div>
    </div>

    <div class="letter-wrap">
      <article id="letterDeals" class="letter">
        <h5>Today’s Special….</h5>
        <div id="dealTitle" class="title">Loading…</div>
        <div id="dealVenue" class="venue"></div>
        <div class="more"><a id="dealLink" href="#" target="_blank" rel="noopener noreferrer">View offer</a></div>
      </article>
    </div>
  </section>
</main>

<div class="reset-wrap">
  <button id="resetBtn" class="reset-btn" aria-label="Reset animation">&#8592;</button>
</div>

<audio id="openSfx" preload="auto">
  <source src="./SocialBurstRandomizer/sfx/letter-open.mp3" type="audio/mpeg"/>
</audio>

<script>
/* === DATA SOURCE (unchanged) === */
const CSV_URL="https://docs.google.com/spreadsheets/d/e/2PACX-1vQi9O78dGEZQ38WWiuMBKKNJwlp6J-yLmPP2lCjJJAHifG1YnpIPVvGt9tKdULSC4ZW9CBiIQOTOx7L/pub?gid=1474444500&single=true&output=csv";

/* === ELEMENTS (existing + new right-hand IDs) === */
const cardEvents = document.getElementById('cardEvents');
const cardDeals  = document.getElementById('cardDeals');

const clickOverlay     = document.getElementById('clickOverlay');
const clickOverlayDeals= document.getElementById('clickOverlayDeals');

const letter   = document.getElementById('letter');
const letterD  = document.getElementById('letterDeals');

const resetBtn = document.getElementById('resetBtn');
const openSfx  = document.getElementById('openSfx');

const evTitle  = document.getElementById('evTitle');
const evVenue  = document.getElementById('evVenue');
const evLink   = document.getElementById('evLink');

const dealTitle= document.getElementById('dealTitle');
const dealVenue= document.getElementById('dealVenue');
const dealLink = document.getElementById('dealLink');

let allRows = [];
let events  = [];
let deals   = [];
let isAnimating = false;

/* === CSV parsing (adds category support; everything else unchanged) === */
function parseCSV(text){
  const rows=text.split(/\r?\n/).filter(l=>l.trim().length);
  if (rows.length < 1) return [];
  const header=rows.shift().split(',').map(h=>h.trim());
  const idx={
    title: header.indexOf('title'),
    venue: header.indexOf('venue_name'),
    url:   header.indexOf('source_url'),
    start: header.indexOf('start_datetime'),
    end:   header.indexOf('end_datetime'),
    cat:   header.indexOf('category') /* NEW: category column */
  };
  return rows.map(line=>{
    const parts=line.split(",");
    return {
      title: parts[idx.title]||'',
      venue: parts[idx.venue]||'',
      url:   parts[idx.url]||'#',
      start_datetime: parts[idx.start]||'',
      end_datetime:   parts[idx.end]||'',
      category: (idx.cat>=0 ? (parts[idx.cat]||'') : '')
    };
  });
}

/* === Time helpers (unchanged) === */
function parseDMYTime(str){
  const s=(str||'').toLowerCase().replace(/\u00a0|\u202f/g,' ').trim();
  if(!s) return null;
  const m=s.match(/^(\d{1,2})(?::(\d{2}))?\s*(am|pm|a\.m\.|p\.m\.)?\s+(\d{1,2})\/(\d{1,2})$/i);
  if(!m) return null;
  let hh=parseInt(m[1],10);
  const mm=m[2]?parseInt(m[2],10):0;
  const ap=(m[3]||'').replace(/\./g,'').toLowerCase();
  const d=parseInt(m[4],10), mo=parseInt(m[5],10);
  const year=(new Date()).getFullYear();
  if(ap==='pm' && hh<12) hh+=12;
  if(ap==='am' && hh===12) hh=0;
  const dt=new Date(year, mo-1, d, hh, mm, 0, 0);
  return isNaN(dt)?null:dt;
}
function isActiveToday(ev, now){
  const s=parseDMYTime(ev.start_datetime);
  let   e=parseDMYTime(ev.end_datetime);
  if(!s && !e) return false;

  const sameDay = (a,b)=>a && b &&
    a.getFullYear()===b.getFullYear() &&
    a.getMonth()===b.getMonth() &&
    a.getDate()===b.getDate();

  const isStartToday = s && sameDay(s, now);
  const isEndToday   = e && sameDay(e, now);
  if(!isStartToday && !isEndToday) return false;

  if(s && !e) e = new Date(s.getTime()+2*60*60*1000);
  const endOfToday = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23,59,59,999);
  const effectiveEnd = (isEndToday && e) ? e : endOfToday;

  return effectiveEnd > now;
}

/* === Category filter helpers (NEW) === */
function normCat(c){
  return (c||'').toLowerCase().replace(/[\s\-]+/g,'_').trim();
}
const EVENT_OK = new Set(['community','live_music','pub_quiz']); // supports "live music"/"pub quiz" via normCat()

/* === Load & split rows once; then filter into events/deals === */
async function loadRows(){
  const res = await fetch(CSV_URL);
  if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
  const txt = await res.text();
  const rows = parseCSV(txt);

  const now = new Date();
  allRows = rows.filter(ev => isActiveToday(ev, now));

  // Left envelope: categories in EVENT_OK
  events = allRows.filter(ev => EVENT_OK.has(normCat(ev.category)));

  // Right envelope: category contains 'deal'
  deals  = allRows.filter(ev => normCat(ev.category).includes('deal'));

  if (events.length===0) events=[{title:'No events left today', venue:'', url:'#'}];
  if (deals.length===0)  deals=[{title:'No discounts today', venue:'', url:'#'}];
}

function pickOne(list){ return list.length ? list[Math.floor(Math.random()*list.length)] : {title:'Nothing today', venue:'', url:'#'}; }
function fillLetter(ev){ evTitle.textContent=ev.title; evVenue.textContent=ev.venue; evLink.href=ev.url; }
function fillLetterDeals(ev){ dealTitle.textContent=ev.title; dealVenue.textContent=ev.venue; dealLink.href=ev.url; }

/* === Scoped state (open one at a time, center when open) === */
function resetBothInstant(){
  cardEvents.classList.remove('is-back','is-open','is-open-centered');
  cardDeals.classList.remove('is-back','is-open','is-open-centered');
  document.body.classList.remove('show-reset','is-open');
}
function openCard(cardEl){
  // Close the other card if open
  const other = (cardEl===cardEvents) ? cardDeals : cardEvents;
  other.classList.remove('is-back','is-open','is-open-centered');

  // Body class for legacy brand fade (unchanged behaviour)
  document.body.classList.add('is-open','show-reset');

  // Flip and center the chosen card
  cardEl.classList.add('is-back');
  setTimeout(()=>{ cardEl.classList.add('is-open'); }, 20);
  setTimeout(()=>{ cardEl.classList.add('is-open-centered'); }, 100);
}

/* === Progressive loading (keep your fast-first render idea) === */
let loadPromise = null;
async function ensureLoaded(){
  if (!loadPromise){
    loadPromise = (async()=>{ await loadRows(); })().catch(e=>{ console.error(e); });
  }
  return loadPromise;
}
window.addEventListener('load', ()=>{ ensureLoaded().catch(()=>{}); });

/* === Click flows (left/right) preserving your timings & sfx === */
async function startEvents(){
  if (isAnimating) return; isAnimating = true;

  // Try quick: if we already have rows, show immediately
  if (events && events.length){ fillLetter(pickOne(events)); }
  else { evTitle.textContent='Loading…'; evVenue.textContent=''; evLink.removeAttribute('href'); }

  openCard(cardEvents);
  setTimeout(()=>{ openSfx.currentTime=0; openSfx.play().catch(()=>{}); },260);

  // Finish animation then allow next
  setTimeout(()=>{ isAnimating=false; }, 1000);

  // If we didn’t have data yet, fill once loaded
  if (!events || !events.length){
    try { await ensureLoaded(); fillLetter(pickOne(events)); } catch(e){}
  }
}

async function startDeals(){
  if (isAnimating) return; isAnimating = true;

  if (deals && deals.length){ fillLetterDeals(pickOne(deals)); }
  else { dealTitle.textContent='Loading…'; dealVenue.textContent=''; dealLink.removeAttribute('href'); }

  openCard(cardDeals);
  setTimeout(()=>{ openSfx.currentTime=0; openSfx.play().catch(()=>{}); },260);
  setTimeout(()=>{ isAnimating=false; }, 1000);

  if (!deals || !deals.length){
    try { await ensureLoaded(); fillLetterDeals(pickOne(deals)); } catch(e){}
  }
}

/* === Event bindings (mirrors your original) === */
clickOverlay.addEventListener('click', startEvents);
clickOverlayDeals.addEventListener('click', startDeals);

letter.addEventListener('click', ()=>{ if(!cardEvents.classList.contains('is-open')) startEvents(); });
letterD.addEventListener('click',   ()=>{ if(!cardDeals.classList.contains('is-open'))  startDeals();   });

resetBtn.addEventListener('click', ()=>{ 
  if(isAnimating) return; 
  isAnimating=true;
  document.body.classList.remove('show-reset','is-open');
  setTimeout(()=>{ 
    resetBothInstant();
    document.querySelector('.brand-badge .brand-name')?.classList.remove('fade-out');
    setTimeout(()=>{ isAnimating=false; },450); 
  },300);
});
</script>
</body>
</html>
